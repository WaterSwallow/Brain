 <!--  Coded by Mohamed Masoud, Sergey Plis Lab,  Sept 2021 -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>3D MRI Segmentation </title>
  <link type="text/css" href="style/index2.css" rel="stylesheet"/>
  <link rel="shortcut icon" href="#">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" type="text/css" href="/lib/webix/webix.css">
  <link rel="stylesheet" type="text/css" href="lib/papaya_lib/papaya.css" />


  <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
  <script src="/lib/webix/webix.js"></script>
 
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>

  <script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script> 

  <script src="https://docs.opencv.org/3.4.0/opencv.js"></script> 
  <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script>  

  <script type="text/javascript" src="js/nifti-reader.js"></script>
  <script type="text/javascript" src="js/nifti-reader-min.js"></script>
<!--   <script type="text/javascript" src="js/mainParameters.js"></script>   -->
  <script type="text/javascript" src="js/mainMeshNetFunctions.js"></script>
  <script type="text/javascript" src="js/mainNiftiReadingFunctions.js"></script> 

  <script type="text/javascript" src="lib/papaya_lib/papaya.js"></script>

        <style>
          .grid-container {
            display: inline-grid;
            grid-template-columns: auto;
            padding: 10px;
          }
          .grid-item {
            background-color: rgba(255, 255, 255, 0.8);
            border: 0px solid rgba(0, 0, 0, 0.8);
            padding: 5px;
            width: 40vw;
            height: 40vh;
            font-size: 15px;
            text-align: center;
          }

          .titleClass {
              font-style: italic;
              font-weight: bold;

          }          
        </style>

        <script type="text/javascript">
            //https://github.com/rii-mango/Papaya/wiki/Configuration
            // MRI Viewer settings
            var params_mri = [];
            params_mri["worldSpace"] = false;
            params_mri["expandable"] = true;
            // To hide the toolbar
            params_mri["kioskMode"] = false;
            params_mri["noNewFiles"] = true;

            papaya.Container.syncViewers = true;

            // MRI Viewer settings
            var params_label = [];
            params_label["worldSpace"] = false;
            params_label["expandable"] = true;
            // To hide the toolbar
            params_label["kioskMode"] = false;            
            params_label["noNewFiles"] = true;
        </script>        
</head>
   
<body>
 
  <script type="text/javascript">


   updateContext = (renderedContext,Threshold, RGB ={ r: 110, g: 255, b: 182 }) => {

        let imgData = renderedContext.getImageData(
            0, 0, renderedContext.canvas.width, renderedContext.canvas.height);
        let pixels = imgData.data;
        for (var i = 0; i < pixels.length; i += 4) {

          if(pixels[i] <= Threshold) {
             pixels[i] = pixels[i + 1] = pixels[i + 2] = 0
          }
        }

        renderedContext.putImageData(imgData, 0, 0);
      }



  refreshDiv = (divId) => { 
      $( "#"+ divId ).load(window.location.href + " #"+ divId );
  }
    

  isLetter = (ch) => {
      return (/[a-zA-Z]/).test(ch)
  }    

  checkGPU = () => {
          let runActivateFlag = true;

          if( ! checkWebGl2() ) {

             document.getElementById("webGl2Status").style.backgroundColor =  "red";

             if( ! checkWebGl1() ) {
                   webix.alert(" WebGL2 and WebGL1 are not supported<br> Run deactivated");
                   // document.getElementById("webGl1Status").style.backgroundColor =  "red";
                   runActivateFlag = false;

             } else {
                  // document.getElementById("webGl1Status").style.backgroundColor =  "green";
                  webix.confirm("WebGL2 is not supported<br> Run process will be very slow").then(function(result){
                         runActivateFlag = true;
                    }).fail(function() {
                        runActivateFlag = false;
                  });
             } 
          } else {
                  console.log("webGl2Status Ok")
                  document.getElementById("webGl2Status").style.backgroundColor =  "green";
                  // document.getElementById("webGl1Status").style.backgroundColor =  "green";
          }

          return runActivateFlag;
  }  


	webix.ready(function () {

		  //  Main Parameters
		  let refFileName = '';
		  let imgFileName = [];
		  let currentID = 1;
		  let imgToRegOpacityValue = 0.5;
		  let imgToSegmentFolder = "images/";
		  let swTimeOut = 1000;	


		  let body = d3.select("body");
		  body.append("div").attr("id","osdLayers");
      body.append("div").attr("id","osdLayers2");


		  let canvas = d3.select("#"+"osdLayers")       /// can be any other selection 
		  .append("canvas")
		  .attr("width", "0%")
		  .attr("height", "0%")
		  .attr("id","inputCanvas")
		  .style('display', 'none');


      let canvas2 = d3.select("#"+"osdLayers2")       
      .append("canvas")
      .attr("width", "0%")
      .attr("height", "0%")
      .attr("id","out3dCC")
      .style('display', 'none');

   	  
      let about = "Demo of 3D MRI Segmentation. <br>By<br> Mohamed Masoud, Sergey Plis<br>2021";
       
      aboutClick = () => {
            webix.alert({
              title:"",
              ok:"Ok",
              text: about
            })
      }




      toolbar = {
          view: "toolbar",
          // css:"webix_dark",
          id: "myToolbar",
          rows:[{ cols: 
                  [
                   { view: "label", label: '<i class="fas fa-brain"/>', width: 30 },
                   { view: "label", label: "Brainchop", css:"titleClass",  inputWidth: 100, align: "left" },
                   { view: "button", id: "About", value: "About", width: 100, align: "right", click: aboutClick }
                  ]
                }
          ]
      }

		  let referenceImage = { view: "form",  id: "referenceImage", elements: [ 
			        { type:"header", template:"Load MRI"},

              { cols:[ 
                      {  view: "label", label: "Select NIfTI file",  
                          align: "left"
                      }, 

              			  { 
              			   view: "uploader" , value: "Browse", width: 100, id:"imageUploader", 
              			   align: "left",
              			   accept: "image/nii, image/nii.gz",
              			   autosend: false, 
              			   multiple: false, 
              			   on: {        
              				        onBeforeFileAdd: function(upload) {        
                  					          let file = upload.file;
                  					          refFileName = file;
                                      console.log("refFileName :", refFileName)
                  					          //file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                  					         if(refFileName["name"].search(".nii") > 0) {
                      					          let reader = new FileReader();  

                      			              var blob = makeSlice(file, 0, file.size);

                      			              reader.onloadend = function(event) {

              			                          if (event.target.readyState === FileReader.DONE) {
              			                              //evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                                                  // params_mri["files"] = [file]; // Or
                                                  params_mri["binaryImages"] = [event.target.result]

                                                  // Set 0 for MRI viewer 
                                                  papaya.Container.resetViewer(0, params_mri);
                                                 
              			                              readNIFTIBasics(event.target.result);
              			                          
              			                              $$("imageUploader").disable();
                                                  
                                                  if(checkGPU()) {
                                                     $$("segmentBtn").enable();
                                                  }

                                                  $$("downloadBtn").disable(); 
              			                          }
                      			             };

                      			             reader.readAsArrayBuffer(blob);

                                    } else {
                                      webix.message("Select Nifti file *.nii / *.nii.gz")
                                    
                                    }     
                      			        
                                    return false;

              				        }
              			      }
              			  }
                    ] 
               }
		     ]
      }



		  let Segmentation = {view: "form", id: "Segmentation", elements: [ 
		          { type:"header", template:"Segmentation Options"},
              { view:"select", 
                label:"Model", 
                id: "selectModel",
                value:1, options:[
                    { id:1, value:"MeshNet GMWM"}, 
                    { id:2, value:"MeshNet Dropout GMWM"}
                ],

                on:{        
                    onChange: function(newValue, oldValue, config) {   
                        model =  load_model(this.getValue());

                   }, 
                    onAfterRender: function() {   
                        model =  load_model(this.getValue());
                   }                   
                }                
              }, 
     
    		      {  cols: [
                          {   
                            view: "label", label: "Inference",  
                            id: "segmentBtnLabel", 
                            align: "left"
                          },                 
                          { 
                            view: "button", label: "Run",  
                            disabled: true,
              		          id: "segmentBtn", 
              		          align: "left",
                            click: function() {
                               webix.message("Please Wait .. ")
                               $$("downloadBtn").disable();
                               $$("segmentBtn").disable();                        
                               runInference();
       
                            }
          		            }
                      ]    
              }, 
              { content: "progressBarDiv" , height:50}
		      ]
       }


      let downloadNiftiFile = {view: "form", id: "downloadNiftiFileId", elements: [ 
              { type:"header", template:"Download"},

              {  cols: [
                    {   view: "label", label: "File Name",  
                        align: "left"
                    },                 
                    { view: "text", 
                      value: "labels.nii",  
                      id: "fileNameToDL", 
                      disabled: false,
                      align: "left",
                      on: {
                        onChange: function(newValue, oldValue, config) {
                          if(newValue.length && allOutputSlices3DCC1DimArray.length && isLetter(newValue[0])) {
                               $$("downloadBtn").enable();
                          } else {
                               $$("downloadBtn").disable();
                          }

                        }
                      }
                    }
                ]    
             },             

              {  cols: [
                    {   view: "label", label: "Labels",  
                        align: "left"
                    },                 
                    { view: "button", label: "Download",  
                      id: "downloadBtn", 
                      disabled: true,
                      align: "left",
                      click: function() {  

                            if(allOutputSlices3DCC1DimArray.length){
                                downloadNifti(allOutputSlices3DCC1DimArray);
                            } else {
                                webix.message("No download Data");
                            }   
                      }  
                    }
                ]    
             }
          ]
       }


    

      let hardwareStatus = {view: "form", id: "hardwareStatusId", elements: [ 
              { type:"header", template:"Status"},

              {  cols: [
                    {   view: "label", label: "WebGL-2",  
                        align: "left"
                    },                 
                    { 
                      view: "label", label: "<span id='webGl2Status' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>",  align: "right" 
                    }
                ]    
             }, 
             // {  cols: [
             //        {   view: "label", label: "WebGL-1",  
             //            align: "left"
             //        },                 
             //        { 
             //          view: "label", label: "<span id='webGl1Status' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>",  align: "right" 
             //        }
             //    ]    
             // },              

             {  cols: [
                    {   view: "label", label: "Memory",  
                        align: "left"
                    },                 
                    { 
                      view: "label", label: "<span id='memoryStatus' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>", align: "right"  
                    }
                ]    
             }             
          ]



       }

		 



		   webix.ui({
		      margin:5,
		      rows:[toolbar,
		      {
    		      margin:20,
    		      padding: 20,
    		      cols: [
                       { width: 250, margin:10,  rows:[
                                    		               referenceImage,
                                                        Segmentation,
                                                        downloadNiftiFile,
                                                        hardwareStatus,
                                                        {}
                                                      ]
                       },
                		   { rows: [ 
                                { type:"header", template:"MRI  Viewer"},
                                { view: "template", id: "p1", content: "papayaMriDiv", borderless:true},
                               ]
                                     
                              },
                              { rows: [ 
                                        { type:"header", template:"Labels Viewer"},
                                        { content: "papayaLabelDiv", borderless:true}
                                      ]
                              }                              
                  ]
    	      }],

		    });
  	 })  








	</script>


    <div class="grid-container" id ="papayaMriDiv">
      <div class="grid-item" id="divMri">
        <div  class="papaya" data-params="params_mri"></div>
     </div>
    </div>  

    <div class="grid-container" id ="papayaLabelDiv">
      <div class="grid-item"><div  class="papaya" data-params="params_label"></div></div>
    </div>  


    <div class="w3-container" style="margin-top: 1vh;" id="progressBarDiv" >
        <div class="w3-border" >
          <div class="w3-green" style="height:2vh;width:0%;" id="progressBar"></div>
        </div>
    </div>


 </body>
</html>